<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GMB | Digital Service Report</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body{
  margin:0;
  padding:16px;
  font-family: system-ui, sans-serif;
  background:#fff;
  color:#0f172a;
}
.container{max-width:600px;margin:auto;}
.logo{display:block;margin:0 auto 10px;max-width:180px;}
h1{text-align:center;font-size:22px;margin-bottom:20px;}

.card{
  background:#fff;
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 8px 20px rgba(0,0,0,.08);
}

label{font-size:14px;font-weight:600;}
input,textarea,select{
  width:100%;
  margin-top:6px;
  padding:12px;
  border-radius:12px;
  border:1px solid #e5e7eb;
  font-size:15px;
}

canvas{
  width:100%;
  height:180px;
  border-radius:12px;
  border:1px dashed #cbd5f5;
  background:#f8fafc;
  touch-action:none;
}

button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:14px;
  background:linear-gradient(135deg,#2563eb,#22c55e);
  color:#fff;
  font-size:16px;
  font-weight:600;
  margin-top:8px;
}

.secondary{background:#64748b;}
.danger{background:#ef4444;}
.small{text-align:center;font-size:12px;color:#64748b;}
.footer{text-align:center;font-size:13px;color:#475569;margin-top:20px;}
</style>
</head>

<body>
<div class="container">

<img src="logo.png" class="logo">
<h1>Digital Service Report</h1>

<div class="card">
<label>Driver</label>
<input id="driver">
<label style="margin-top:12px;">Service Address</label>
<textarea id="address"></textarea>
</div>

<div class="card">
<label>Service Photos</label>
<input type="file" id="cameraInput" accept="image/*" capture hidden>
<button class="secondary" onclick="cameraInput.click()">ðŸ“· Take Photo</button>
<input type="file" id="galleryInput" accept="image/*" multiple hidden>
<button class="secondary" onclick="galleryInput.click()">ðŸ–¼ Gallery</button>
<div class="small" id="photoCount">0 photos selected</div>
</div>

<div class="card">
<label>Service Performed</label>
<div id="serviceLines"></div>
<button class="secondary" onclick="addLine()">âž• Add Line</button>
</div>

<div class="card">
<label>Customer Signature</label>
<canvas id="signature"></canvas>
<button class="danger" onclick="clearSig()">ðŸ§½ Clear</button>
</div>

<div class="card">
<button onclick="generatePDF()">ðŸ“„ Generate PDF</button>
</div>

<div class="footer">
GMB Window & Bathtub Company<br>
+1 (646) 671-6849
</div>

</div>

<script>
/* ========= GLOBAL ========= */
let images = [];

/* ========= SIGNATURE (FIX DEFINITIVO) ========= */
const canvas = document.getElementById("signature");
const ctx = canvas.getContext("2d");
let drawing=false;

function setupCanvas(){
  const ratio = window.devicePixelRatio || 1;
  const data = canvas.toDataURL();
  canvas.width = canvas.offsetWidth * ratio;
  canvas.height = 180 * ratio;
  ctx.setTransform(ratio,0,0,ratio,0,0);
  if(data.length > 10){
    const img=new Image();
    img.onload=()=>ctx.drawImage(img,0,0);
    img.src=data;
  }
}
setupCanvas();
window.addEventListener("resize",setupCanvas);

canvas.addEventListener("pointerdown",e=>{
  drawing=true;
  ctx.beginPath();
  ctx.moveTo(e.offsetX,e.offsetY);
});
canvas.addEventListener("pointermove",e=>{
  if(!drawing) return;
  ctx.lineWidth=3;
  ctx.lineCap="round";
  ctx.strokeStyle="#2563eb";
  ctx.lineTo(e.offsetX,e.offsetY);
  ctx.stroke();
});
canvas.addEventListener("pointerup",()=>drawing=false);
canvas.addEventListener("pointerleave",()=>drawing=false);
canvas.addEventListener("touchmove",e=>e.preventDefault(),{passive:false});

function clearSig(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
}

/* ========= PHOTOS ========= */
cameraInput.onchange=()=>{
  if(cameraInput.files[0]) images.push(cameraInput.files[0]);
  photoCount.innerText=`${images.length} photos selected`;
  cameraInput.value="";
};
galleryInput.onchange=e=>{
  for(const f of e.target.files) images.push(f);
  photoCount.innerText=`${images.length} photos selected`;
};

/* ========= SERVICE LINES ========= */
function addLine(){
  const d=document.createElement("div");
  d.style.display="flex";
  d.style.gap="6px";
  d.style.marginTop="6px";
  d.innerHTML=`
  <select class="area"><option>Area</option><option>Bathroom</option></select>
  <select class="service"><option>Service</option><option>Repair</option></select>
  <input class="qty" type="number" value="1" style="width:60px">
  <button class="danger" onclick="this.parentElement.remove()">ðŸ—‘</button>`;
  serviceLines.appendChild(d);
}

/* ========= PDF + SHARE ========= */
async function generatePDF(){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  let y=20;

  pdf.text("SERVICE REPORT",105,y,{align:"center"});
  y+=10;

  pdf.text("Photos:",10,y); y+=6;

  for(const f of images){
    try{
      const img=await toBase64(f);
      pdf.addImage(img,"JPEG",15,y,80,55);
      y+=60;
    }catch(e){console.warn("Image skipped",e);}
  }

  const sig = canvas.toDataURL("image/png");
  pdf.text("Signature:",10,y); y+=6;
  pdf.addImage(sig,"PNG",15,y,80,30);

  const blob = pdf.output("blob");

  if(navigator.share){
    await navigator.share({
      files:[new File([blob],"GMB_Report.pdf",{type:"application/pdf"})],
      title:"Service Report"
    });
  }else{
    pdf.save("GMB_Report.pdf");
  }
}

function toBase64(f){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=()=>res(r.result);
    r.onerror=rej;
    r.readAsDataURL(f);
  });
}
</script>
</body>
</html>